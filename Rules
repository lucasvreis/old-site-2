#!/usr/bin/env ruby

ignore '/**/org-imports/*'

route '/blog/**/*' do
  y,m,d,slug = /(\d+)\-(\d+)\-(\d+)\-([^\/\.]+)/
                 .match(item.identifier).captures

  if item.identifier =~ "/blog/*.{html,org,md,erb}"
    "/#{y}/#{m}/#{d}/#{slug}/index.html"
  else
    rest, = /\d+\-\d+\-\d+\-(.*)/
             .match(item.identifier).captures
    "/#{y}/#{m}/#{d}/#{rest}"
  end
end

route '/**/index.*' do
  item.identifier.without_ext + '.html'
end

route '/**/*.{html,org,md,erb}' do
  item.identifier.without_ext + '/index.html'
end

route '/**/*' do
  item.identifier.to_s
end

# Maybe we don't need html at all
# compile '/**/*.html' do
#   layout '/default.*'
# end

require 'set'

preprocess do
  tags = Set.new
  @items.each do |item|
    if item[:tags]
      item[:tags].each { |t| tags.add(t.downcase) }
    end
  end

  tags.each do |tag|
    @items.create(
      "",
      { :tag => tag },
      "/tags/#{tag}/index.html")
  end

  @config[:tags] = tags
end

compile '/tags/**/*' do
  layout '/tags.*'
end

compile '/media/*svg' do
  filter :scale_svgs, scale: 1.3
end

compile '/*.erb' do
  filter :erb
  layout '/default.*'
end

compile '/**/*.md' do
  filter :kramdown
  layout '/default.*'
end

compile '/**/*.org' do
  args = [{:from => :org,
           :to => :html5,
           :metadata => 'lang:pt-BR',
           :shift_heading_level_by => 1 },
          :mathjax]

  args += [{:lua_filter => './lib/org_bib.lua',
            :csl => 'citstyle.csl'},
           :citeproc] if @item[:citations]

  args.append({:lua_filter => './lib/latex-fig.lua'}) if @item[:latex]

  filter :pandoc, args: args

  filter :typogruby

  if @item[:layout]
    layout @item[:layout]
  else
    layout '/article.*'
  end
end

compile '/**/*' do
end

layout '/**/*', :erb
